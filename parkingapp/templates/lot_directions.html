{% extends 'base.html' %}
{% load static %}
{% load math_extras %}

{% block title %}{{ lot.lot_name }} - Directions{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <!-- Back Button -->
            <div class="mb-4">
                <a href="{% url 'parking_map' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Map
                </a>
            </div>

            <!-- Lot Information Card -->
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">üìç {{ lot.lot_name }}</h2>
                </div>
                <div class="card-body">
                    <!-- Main Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Availability</h5>
                            <p class="display-4 text-success">
                                {{ available_spots }}/{{ total_spots }}
                                <small class="text-muted">spots available</small>
                            </p>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ occupancy_percent }}%"
                                     aria-valuenow="{{ occupancy_percent }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ occupancy_percent|floatformat:1 }}% Occupied
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Status</h5>
                            {% if available_spots == 0 %}
                                <span class="badge badge-danger badge-lg p-3" style="font-size: 1.1em;">üî¥ FULL</span>
                            {% elif available_spots < total_spots|mul:0.3 %}
                                <span class="badge badge-warning badge-lg p-3" style="font-size: 1.1em;">üü° LIMITED SPOTS</span>
                            {% else %}
                                <span class="badge badge-success badge-lg p-3" style="font-size: 1.1em;">üü¢ AVAILABLE</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Location Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted">üìÆ ADDRESS</h6>
                                <p class="lead">{{ settings.address }}</p>
                            </div>
                            <div class="mb-3">
                                <h6 class="text-muted">üì± PHONE</h6>
                                <p class="lead">
                                    <a href="tel:{{ settings.phone }}">{{ settings.phone }}</a>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted">üìç COORDINATES</h6>
                                <p class="lead">
                                    <code>{{ settings.latitude }}, {{ settings.longitude }}</code>
                                </p>
                            </div>
                            <div class="mb-3">
                                <h6 class="text-muted">üïê OPERATING HOURS</h6>
                                <p class="lead">
                                    {{ settings.opening_time }} - {{ settings.closing_time }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="row">
                        <div class="col-12">
                            <a href="{{ directions_url }}" target="_blank" class="btn btn-primary btn-lg btn-block mb-2">
                                <i class="fas fa-map"></i> Open in Google Maps
                            </a>
                            <button onclick="copyLocation()" class="btn btn-info btn-block mb-2">
                                <i class="fas fa-copy"></i> Copy Coordinates
                            </button>
                            <a href="{% url 'reserve_parking' %}" class="btn btn-success btn-block">
                                <i class="fas fa-ticket-alt"></i> Reserve a Spot
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Embedded Map -->
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üó∫Ô∏è Location Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 400px; border-radius: 0 0 8px 8px;"></div>
                </div>
            </div>

            <!-- JSON Data Display -->
            <div class="card mt-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìã Raw Data (JSON)</h5>
                </div>
                <div class="card-body">
                    <pre><code id="jsonData" style="font-size: 0.85em;">{{ json_data }}</code></pre>
                    <button onclick="copyJSON()" class="btn btn-sm btn-secondary">
                        <i class="fas fa-copy"></i> Copy JSON
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    .badge-lg {
        font-size: 1.2em;
    }
    
    code {
        background-color: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    #jsonData {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
    }
</style>

<script>
    // Initialize map
    const latitude = {{ settings.latitude }};
    const longitude = {{ settings.longitude }};
    const map = L.map('map').setView([latitude, longitude], 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add marker
    L.marker([latitude, longitude]).addTo(map)
        .bindPopup('<strong>{{ lot.lot_name }}</strong><br>{{ settings.address }}')
        .openPopup();
    
    // Copy coordinates to clipboard
    function copyLocation() {
        const coords = latitude + ', ' + longitude;
        navigator.clipboard.writeText(coords).then(function() {
            alert('‚úì Coordinates copied: ' + coords);
        });
    }
    
    // Copy JSON to clipboard
    function copyJSON() {
        const jsonData = `{
  "lot_id": {{ lot.lot_id }},
  "name": "{{ lot.lot_name }}",
  "address": "{{ settings.address }}",
  "latitude": {{ settings.latitude }},
  "longitude": {{ settings.longitude }},
  "phone": "{{ settings.phone }}",
  "available_spots": {{ available_spots }},
  "total_spots": {{ total_spots }},
  "occupancy_percent": {{ occupancy_percent }},
  "directions_url": "{{ directions_url }}"
}`;
        navigator.clipboard.writeText(jsonData).then(function() {
            alert('‚úì JSON data copied to clipboard');
        });
    }
</script>

{% endblock %}
